# -*- coding: utf-8 -*-
#+STARTUP: overview
#+PROPERTY: header-args :mkdirp yes
  
* COMMENT early-init.el
  #+begin_src emacs-lisp :tangle ~/.emacs.d/early-init.el
    (push '(menu-bar-lines . 0) default-frame-alist)
    (push '(tool-bar-lines . 0) default-frame-alist)
    (push '(vertical-scroll-bars) default-frame-alist)
  #+end_src
* init.el
  
  #+begin_src emacs-lisp :tangle ~/.emacs.d/init.el
    (add-to-list 'load-path (expand-file-name "~/.emacs.d/lisp/"))
    (setq default-directory "~/")
    (setq delete-by-moving-to-trash t)

    (prefer-coding-system 'utf-8)

    (defun open-init-file ()
      (interactive)
      (find-file "~/HL-emacs.d/config.org"))

    (global-set-key (kbd "<f2>") 'open-init-file)
    (global-set-key (kbd "<f5>") 'revert-buffer)
    (global-set-key (kbd "C-x C-b") 'ibuffer)
    ;;(fido-mode t)

    (require 'init-elpa)

    (require 'init-completion)
    (require 'init-edit)
    ;; (require 'init-lsp)
    (require 'init-markdown)
    (require 'init-org)
    (require 'init-ui)
    (require 'init-utils)

  #+end_src
  
* init-completion
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-completion.el
    (use-package company
      :diminish
      :defines (company-dabbrev-ignore-case company-dabbrev-downcase)
      :hook (after-init . global-company-mode))

    (use-package counsel
      :diminish ivy-mode counsel-mode
      :bind (("C-s" . swiper-isearch)
	     ("C-r" . swiper-isearch-backward))
      :hook ((after-init . ivy-mode)
	     (ivy-mode . counsel-mode))
      :init
      (setq ivy-count-format "%d/%d "
	    ivy-use-virtual-buffers t
	    ivy-initial-inputs-alist nil))

    (provide 'init-completion)

  #+end_src

* init-edit
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-edit.el
    ;; (use-package imenu
    ;; 	 :bind (("C-." . imenu)))

    (use-package undo-tree
         :diminish
         :hook (after-init . global-undo-tree-mode)
         :init
         (setq undo-tree-visualizer-timestamps t
               undo-tree-enable-undo-in-region nil
               undo-tree-auto-save-history nil))

    (provide 'init-edit)
  #+end_src
* init-elpa
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-elpa.el
    (setq package-archives '(("gnu"   . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
			     ("melpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")))

    (require 'package)
    (package-initialize)

    (unless (bound-and-true-p package--initialized)
      (package-initialize))

    (unless (package-installed-p 'use-package)
      (package-refresh-contents)
      (package-install 'use-package))

    (eval-and-compile
      (setq use-package-always-ensure t
	    use-package-always-defer t
	    use-package-expand-minimally t)
      (require 'use-package))

    (use-package diminish)
    (use-package delight)


    (provide 'init-elpa)
  #+end_src
  
* COMMENT init-lsp
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-lsp.el
    (use-package lsp-mode
      :init
      (setq lsp-keymap-prefix "C-c l")
      :hook (;; replace XXX-mode with concrete major-mode(e. g. python-mode)
             (cc-mode . lsp))
      :commands lsp)
    (provide 'init-lsp)
  #+end_src
* init-markdown
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-markdown.el
    (use-package markdown-mode
      :mode (("README\\.md\\'" . gfm-mode)
             ("\\.md\\'" . markdown-mode)))

    (use-package auctex)

    (setq-default TeX-engine 'xetex)
    ;; (add-hook 'LaTeX-mode-hook
    ;;           (lambda ()
    ;;             (setq TeX-engine 'xetex)))

    (provide 'init-markdown)
  #+end_src
  
* init-org

  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-org.el
    ;; org variable
    (setq org-startup-truncated nil)
    (setq org-log-done 'time)
    (setq org-log-into-drawer t)
    (setq org-agenda-include-diary t)
    (setq system-time-locale "C")
    (setq org-startup-indented t)

    ;; calendar and diary
    (setq calendar-date-style 'iso)
    (setq diary-show-holidays-flag nil)

    ;; org agenda
    (setq org-agenda-files '("~/GTD/inbox.org"
                             "~/GTD/task.org"
                             "~/GTD/schedule.org"
                             "~/GTD/relax.org"
                             "~/GTD/habit.org"))

    ;; org export
    (require 'org-tempo)
    (setq org-export-backends '(latex md html ascii))

    ;; key bind
    ;; (global-set-key (kbd "C-c l") #'org-store-link)
    (global-set-key (kbd "C-c a") #'org-agenda)
    ;; (global-set-key (kbd "C-c c") #'org-capture)

    ;; epa
    ;; (require 'epa-file)
    ;; (epa-file-enable)
    ;; (setq epa-file-encrypt-to nil
    ;;       epa-file-cache-passphrase-for-symmetric-encryption t)

    ;; org-crypt
    ;; (require 'org-crypt)
    ;; (org-crypt-use-before-save-magic)
    ;; (setq auto-save-default nil)
    ;; (setq org-tags-exclude-from-inheritance '("crypt"))
    ;; (setq org-crypt-key nil)

    (provide 'init-org)
  #+end_src

* init-ui
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-ui.el
    (setq ring-bell-function 'ignore)
    (global-display-line-numbers-mode)
    (tool-bar-mode 0)
    ;;(global-linum-mode 1)
    (scroll-bar-mode -1)
    (setq-default cursor-type 'bar)

    (setq show-paren-delay 0)
    (show-paren-mode 1)

    (winner-mode 1)

    (setq inhibit-splash-screen 1)

    (fset 'yes-or-no-p 'y-or-n-p)
    (define-key y-or-n-p-map [return] 'act)

    (setq initial-scratch-message ";; Never gonna give you up ~\n\n")

    (setq default-frame-alist '((font . "JetBrains Mono-16")))
    (set-face-attribute 'default nil :font "JetBrains Mono-16")
    ;;(set-fontset-font "fontset-default" 'han "微软雅黑")
    (set-fontset-font "fontset-default" 'han "霞鹜文楷")

    ;;(add-to-list 'default-frame-alist '(font . "JetBrains Mono-14"))
    (add-to-list 'default-frame-alist '(width . 90))
    (add-to-list 'default-frame-alist '(height . 28))

    ;; 这是一行中文
    ;;(use-package cnfonts
    ;;  :hook (after-init . cnfonts-mode))

    (setq-default c-basic-offset   4
                  tab-width        4
                  indent-tabs-mode nil)

    (provide 'init-ui)

  #+end_src

* init-utils
  #+begin_src emacs-lisp :tangle ~/.emacs.d/lisp/init-utils.el

    (use-package which-key
      :hook (after-init . which-key-mode))

    (use-package magit
      :bind (("C-x g" . magit-status)))

    (provide 'init-utils) 
  #+end_src
  
* runemacs.bat
最开始的方案是在bat文件里指定HOME目录
  #+begin_src
set HOME=C:\Users\<username>
"C:\portable\emacs-27.2-x86_64\bin\runemacs.exe"
  #+end_src

后来切换到守护进程(daemon)方式来运行emacs，于是设置了HOME变量并整了个ahk脚本
#+begin_src
#NoEnv  ; Recommended for performance and compatibility with future AutoHotkey releases.
; #Warn  ; Enable warnings to assist with detecting common errors.
SendMode Input  ; Recommended for new scripts due to its superior speed and reliability.
SetWorkingDir %A_ScriptDir%  ; Ensures a consistent starting directory.

run C:\portable\emacs-27.2-x86_64\bin\runemacs.exe --daemon, ,Hide
#+end_src

